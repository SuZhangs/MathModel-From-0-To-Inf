# LaTeX 中的浮动体：浮动算法



## 浮动体相关的术语



### 浮动体类型

每个浮动体都从属于一种浮动体类型。默认情况下，LaTeX 定义了两种浮动体类型，即 `figure` 和 `table`。文档类和宏包的作者，可以在其中定义额外的浮动体类型



一个浮动体类型中的不同浮动体，它们的相对顺序是固定的。也就是说，不管浮动体如何「乱跑」，Figure 1, Figure 2, Figure 3 这样的顺序是始终保持的。不同类型的浮动体之间，其顺序则可能出现穿插。比如，如果有 Table 1，则可以出现在相对上述三个图片的任意位置。

### 浮动区域

在同一栏（column）当中，LaTeX 设置了两个浮动区域：栏的顶部和底部。对于双栏排版来说，LaTeX 还提供了额外的区域：跨过双栏的顶部。

此外，LaTeX 种也有所谓的「浮动栏」或者「浮动页」的设定。顾名思义，浮动栏和浮动页就是「只有浮动体」的栏或者页。

最后，LaTeX 也可以将浮动体放在文本内容的中间（当然，这需要显式指定）。

### 浮动体位置选项

```latex
\begin{figure}[!htbp]
% ...
\end{figure}
```

1

```latex
\begin{figure}[!htbp]  

%错误想法：浮动体会尝试先放到h，然后依次是t、b、p。
%%浮动体位置选项的指定是一个「组合」问题，而不是「排列问题」。因此，[tb] 和 [bt] 是等效的。并不是说 [bt] 表示首先尝试放在栏的底部。【好复杂啊，那么到底都有哪些组合呢？】

%【知道啦,h的优先级最高，t的优先级次之，b的优先级最低。p仅在分页时起作用。如果htb都不满足且不分页，那么浮动体就会被加入“等待序列”】

%! 表示忽略一些严格的限制条件（后文详述）；
%h 表示如有可能，则放在当前位置；
%t 表示该浮动体允许置于栏的顶部；
%b 表示该浮动体允许置于栏的底部；
%p 表示该浮动体允许置于浮动栏或浮动页。
%如果没有以上哪个字符，表示该浮动体不允许置于在相应位置。
% ...
\end{figure}
```

### 浮动算法参数

> 直接引用自 [这里](https://liam.page/2017/04/30/floats-in-LaTeX-the-positioning-algorithm/)

总计，大约有 20 个参数，会最终影响到 LaTeX 的浮动体算法。根本来说，这些参数限制了

- 某个浮动区域至多允许摆放多少个浮动体，
- 浮动区域的大小，
- 非浮动栏或非浮动页中，文字区域的最小大小，
- 一个浮动区域内连续浮动体之间的垂直距离，以及
- 浮动区域与其前后文字区域的垂直距离

## 浮动算法

LaTeX 中所有的排版算法，都在尽力避免「回溯」。如果 LaTeX 确定输出了一个浮动体，那么不论之后遇到什么内容，它的位置都不会发生改变。

### 基本流程

- 当 LaTeX 遇到一个浮动体1，它都会先检查等待队列中是否有与该浮动体1同属一个浮动体类型的浮动体2尚未输出。随后会根据浮动算法的规则（后文详述）尽可能快地输出浮动体2。
  - 若成功，则该浮动体2被输出，并且 LaTeX 再也不会改变它的位置。浮动体1放入等待队列中。
  - 若失败，则该浮动体1和2都被 LaTeX 放在一个等待队列中暂存，而后在下一页开始的时候尝试输出队列中的浮动体。当 LaTeX 读入一个浮动体时，

* 如果位置选项中包含 `!`，则在处理该浮动体时，LaTeX 会忽略一些严格的限制（当前浮动区域允许放置浮动体的最大数量、当前浮动区域的最大面积）。

  

  **四个计数器**

  - `totalnumber`（默认为 3），在非浮动页上浮动体的最大数量。
  - `topnumber`（默认为 2），在一个栏的顶部浮动体的最大数量。
  - `bottomnumber`（默认为 1），在一个栏的底部浮动体的最大数量。
  - `dbltopnumber` （默认为 2），在双栏排版中，横跨双栏的顶部浮动体的最大数量。

  **五个区域比例**

  - `\topfraction`（默认为 0.7），栏的顶部区域占据当前栏的最大比例。
  - `\bottomfraction`（默认为 0.3），栏的底部区域占据当前栏的最大比例。
  - `\dbltopfraction`（默认为 0.7），在双栏排版中，横跨双栏的顶部区域占据当前页的最大比例。
  - `\textfraction`（默认为 0.2），在非浮动栏或浮动页中，文字区域占据的最小比例。
  - `\floatpagefraction`（默认为 0.5），在浮动栏或浮动页中，浮动体至少应当占据的最小比例。

  **五个垂直距离**，它们的默认值取决于文档类默认字号。

  - `\floatsep`，栏的顶部或底部区域中，连续浮动体之间的垂直距离。
  - `\dblfloatsep`，双栏排版中，横跨双栏的浮动区域中，浮动体之间的垂直距离。
  - `\textfloatsep`，栏的顶部或底部的浮动区域与文字区域之间的垂直距离。
  - `\dbltextfloatsep`，双栏排版中，横跨双栏的浮动区域与文字区域之间的垂直距离。
  - `\intextsep`，对于 `h` 生效的浮动体，与前后文字之间的垂直距离。



* 当 LaTeX 遇到 `\clearpage`/`FloatBarrier` 或者文档末尾时，LaTeX 会新建一个页面，而后将等待列表中的所有浮动体，都输出在浮动栏或浮动页中（而不论这些浮动体的位置选项是否指定了 `p`）。
* 当 LaTeX 分页时，会首先检查浮动体等待队列，并尽可能地清空它。为此，LaTeX 会尝试构建浮动栏或浮动页。必须有 `p` 指定的浮动体，才会被放在浮动栏或浮动页中。

## 浮动算法导致的一些现象及其解释

### 浮动体可能出现在源代码相对位置之前

浮动体在源代码中的位置，决定了它在最终输出的文档中可能出现的最早的位置。这一最早位置是「当前栏的顶部区域」。

### 双栏排版中，跨栏浮动体总是被放入等待列表

跨栏浮动体总是被 LaTeX 立即放入等待列表当中；也因此，跨栏浮动体最在也要输出在**下一页**的顶部。如果期待跨栏浮动体放在当前页的顶部区域，那么 LaTeX 必须回溯，破坏已经排版好的第一栏。

### 双栏排版中，跨栏浮动体不可以被放在底部区域

在 LaTeX 的双栏排版中，没有为跨栏浮动体设置底部区域。因此，如果你使用 `\begin{figure*}[b]`，那么因为它不允许放在顶部区域，所以它直到遇见 `\clearpage`/`\FloatBarrier` 或者文档末尾时，才会被输出。

### `h` 真的只表示「如果可能的话，放在这里」

`h` 选项仅在一种情况下可能生效：**等待列表中没有该类型的浮动体，并且当前页有足够的空间供其摆放**。

如果用户希望表达「我一定要放在这里」，那么需要使用 `float` 宏包提供的 `H` 选项

## 浮动体算法的文档

参见 `source2e.pdf`，`ltoutput.dtx` 部分【请麻烦在issue里提醒我给这里加上超链接】



参考学习自：https://liam.page/2017/04/30/floats-in-LaTeX-the-positioning-algorithm/
